---
title: "PECIG Colombia"
subtitle: "Diversidad de suelos"
author: "Carlos Guio"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: journal
    highlight: tango
    keep_md: true
---


```{r setup, message=FALSE, warning=FALSE}

library(tidyverse)
library(rgdal) #leer polígono
library(sf) #manipular objetos espaciales tipo sf
library(colorblindr)
library(showtext) #fuentes de goolge
library(colorspace) #lighten or darken colors
library(ggrepel) #etiquetas 
library(ggsn) #escala gráfica
library(gghalves)
library(wesanderson)


knitr::opts_chunk$set(include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align="center", fig.showtext = TRUE, fig.retina = 1, dpi = 300, out.width = "70%")

showtext_auto()

```

```{r theme_setup}

pal <- wes_palette("Zissou1", 100, type = "continuous")

# Obtener fuentes
font_add_google(name = "Roboto Condensed", family= "robotoc")
font_add_google(name = "Roboto", family= "roboto")


# Definir theme
theme_set(theme_minimal(base_family = "roboto"))

theme_update(panel.grid = element_blank(),
             axis.text = element_text(family = "robotoc",
                                        color = "#c3beb8"),
             axis.title = element_blank(),
             axis.ticks =  element_line(color = "#c3beb8", size = .7),
             legend.title = element_text(size = 13, 
                                         face = "bold", 
                                         color = "grey20", 
                                         family = "roboto"),
             legend.text = element_text(size = 9, 
                                        color = "#c3beb8", 
                                        family = "robotoc",
                                        face = "bold"),
             legend.key.size = unit(0.8, "cm"))

```


## Rationale

Los datos de suelo en la toma de decisiones ambientales. Los tipos de datos de suelo posibles. Su representación.

## Los datos

Los polígonos donde se realizaría la aspersión -llamados núcleos en el documento del PECIG(2020) - se obtuvieron de la página web de la Agencia Nacional de Licencias Ambientales (ANLA). La información geográfica de suelos por departamento se obtuvo de los datos abiertos del IGAC en 2019 y 2020. La información de perfiles de suelo se obtuvo de los estudios de suelo del IGAC de los departamentos respectivos, publicados en 2014. Debido a la disponibilidad de datos, se presentan únicamente los casos del núcleo san josé (departamentos Meta, Vichada y Guaviare) y el núcleo caquetá (departamento Caquetá) .


```{r load_raw}

#Como mejorar velocidad? modificar los .shp originales para que tengan tablas de atributos solo con los campos necesarios.

#Cargar datos espaciales

temp <- tempfile() #Crear objetos temporales
tempd <- tempdir()

urls <- list()

urls$nucleos <- "https://github.com/cmguiob/TERRAE_PECIG_dashaboard/blob/main/Datos_SIG/Area_Influencia_Directa_19022020.zip?raw=true"

urls$deptos <- "https://github.com/cmguiob/TERRAE_PECIG_dashaboard/blob/main/Datos_SIG/DIVA_adm_colombia.zip?raw=true"

urls$deptos_nucleos <- "https://github.com/cmguiob/TERRAE_PECIG_dashaboard/blob/main/Datos_SIG/Suelos_Departamentos_Nucleos_1_2.zip?raw=true"


for (i in 1:length(urls)){
  download.file(urls[[i]],temp, mode="wb")
  unzip(temp, exdir=tempd) #Descomprimir
}

files_names <- list.files(tempd, pattern = "*.geojson") #Leer nombres de archivos
files_paths <- paste(file.path(tempd), files_names[], sep = "\\") #Crear rutas

# Crear objetos
nucleos <- files_paths %>% .[str_detect(.,"Area_Influencia_Directa")] %>% st_read()
deptos <- files_paths %>% .[str_detect(.,"adm")] %>% st_read()
meta_nucleo <- files_paths %>% .[str_detect(.,"meta_")] %>% st_read()
guaviare_nucleo <- files_paths %>% .[str_detect(.,"guaviare_")] %>% st_read()
vichada_nucleo <- files_paths %>% .[str_detect(.,"vichada_")] %>% st_read()
caqueta_nucleo <- files_paths %>% .[str_detect(.,"caqueta_")] %>% st_read()


#Cargar resultados del algoritmo.
RAO_nucleos <- read_csv("https://raw.githubusercontent.com/cmguiob/TERRAE_PECIG_dashaboard/main/Resultados/Pedodiversidad_RAO_nucleos_1_2.csv") %>%
  mutate(NUCLEO = case_when(
    NUCLEO_ID == 1 ~ "San Jose",
    NUCLEO_ID == 2 ~ "Caqueta"))

unlink(temp)
unlink(tempd)
```


```{r mapa_deptos, include = TRUE, echo = TRUE}

ggplot() + 
  geom_sf(data = deptos %>% 
            filter(NAME_1 %in% c("Meta", "Vichada", "Guaviare", "Caquetá")),
          aes(fill = NAME_1),
          color = NA) +
  geom_sf(data = nucleos, fill = "grey70", color = NA, alpha = 0.7)+
  scale_x_continuous(breaks=c(-78, -74, -70))+
  scale_y_continuous(breaks=c(0,4,8)) +
  scale_fill_OkabeIto()+
  guides(fill = guide_legend( title = "Departamento")) 
  
```

## Preprocesamiento en QGIS

A los polígonos obtenidos del IGAC se les corrigieron geometrías y se generaron índices espaciales en QGIS. Posteriormente se realizaron las intersecciones de los polígonos de suelos por departamento con los polígonos de núcleos de aspersión, para limitar el objeto de estudio, utilizando la función clip. A los polígonos resultantes se les agregó una campo que especifíca el núcleo.


```{r mapa_nucleos, include = TRUE, echo = TRUE}

#plot department clipped to nucleos
ggplot() + 
  geom_sf(data = nucleos, fill = "grey70", color = NA, alpha = 0.7)+
  geom_sf(data = meta_nucleo, color = NA, fill = "#069d73")+
  geom_sf(data = vichada_nucleo, color = NA, fill = "#f0e443")+
  geom_sf(data = guaviare_nucleo, color = NA, fill="#57b4e9")+
  geom_sf(data = caqueta_nucleo, color = NA, fill = "#e69f16")+
  scale_x_continuous(breaks=c(-78, -74, -70))+
  scale_y_continuous(breaks=c(0,4,8))

```

## Indice de pedodiversidad

En los polígonos de suelos resultantes se identifican los códigos de las UCS, los suelos que las conforman y los identificadores de los perfiles de suelos. 

Para estimar la pedodiversidad se utilizó el algoritmo propuesto por Rositter para estimar la similitud entre suelos. La automatización la estoy documentando en otro repositorio (link). Según el algorítmo...

Los polígonos y los índices de pedodiversidad


```{r prep_RAO}

#Join estimados de pedodiversidad con poligonos

meta_RAO <- inner_join(meta_nucleo, RAO_nucleos %>% filter(DEPARTAMENTO == "Meta"), by = c("UCS_F", "DEPARTAMENTO", "NUCLEO"))  

guaviare_RAO <- inner_join(guaviare_nucleo, RAO_nucleos %>% filter(DEPARTAMENTO == "Guaviare"), by = c("UCS_F", "DEPARTAMENTO", "NUCLEO")) 

vichada_RAO <- inner_join(vichada_nucleo, RAO_nucleos %>% filter(DEPARTAMENTO == "Vichada"), by = c("UCS_F", "DEPARTAMENTO", "NUCLEO")) 

caqueta_RAO <- inner_join(caqueta_nucleo, RAO_nucleos %>% filter(DEPARTAMENTO == "Caqueta"), by = c("UCS_F", "DEPARTAMENTO", "NUCLEO"))  

```

## Resultados



```{r mapa_RAO, include = TRUE, echo = TRUE}

ggplot() +
  geom_sf(data = meta_RAO, aes(fill = RAO), color = NA )+
  geom_sf(data = guaviare_RAO, aes(fill = RAO),color = NA)+
  geom_sf(data = vichada_RAO, aes(fill = RAO),color = NA)+
  geom_sf(data = caqueta_RAO, aes(fill = RAO),color = NA)+
  scale_fill_gradientn(colours = pal)+
  theme(legend.position = "top")+
  guides(fill = guide_colourbar(title.position = "top",
                                title.hjust = 0.5,
                                barwidth = unit(15,"lines"),
                                barheight = unit(0.5,"lines")))+
  scale_x_continuous(breaks=c(-76, -73, -70))+
  scale_y_continuous(breaks=c(2,4))

```



```{r plot_UCS}

#graficar EDA de UCS

# Temporal, mientras la función queda lista
RAO_nucleos_vf <- RAO_nucleos[RAO_nucleos$UCS_F %in% rbind(meta_nucleo$UCS_F,guaviare_nucleo$UCS_F, vichada_nucleo$UCS_F, caqueta_nucleo$UCS),]

plot_EDA <- ggplot(RAO_nucleos_vf, aes(y = RAO, x = NUM_SUELOS)) +
  geom_half_violin(width=1.4, alpha=0.4, color = NA, fill = "#CDC0B0", trim = FALSE, side = "l")+
  geom_boxplot(width=0.2, color="black",show.legend = FALSE,  alpha=0.4, lwd=0.2, outlier.size = 0.001)+
  geom_half_point_panel(aes(color = UCS_TIPO), alpha = 0.6, side = "r", range_scale = 0.1, size = 0.4, transformation = position_jitter())+
  scale_colour_manual(name = "Tipo de UCS", 
                      values = c("Consociacion" = "#5B9F90", "Asociacion" = "#B6B800","Complejo" = "#F0C73B",  "Disociacion" = "#E96149"),
                      breaks=c('Disociacion','Complejo','Asociacion','Consociacion'))+
  theme_bw(base_size = 9, base_family = "Comfortaa")+
  guides(color = guide_legend(override.aes = list(size = 2)))+
  labs(y = "Incertidumbre (entropía cuadratica)", x = "Numero de suelos reportados por UCS")+
  facet_grid(~ DEPARTAMENTO, scales = "free")+
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face="bold", color = "#CDC5BF", size = 9),
    axis.text = element_text(size=6.5),
    axis.title= element_text(size = 7.5),
    axis.title.x = element_text(margin = margin(t = 8)),
    axis.title.y = element_text(margin = margin(r = 8)),
    axis.ticks.length.x = unit(.5, "mm"),
    axis.ticks.length.y = unit(.1, "mm"),
    axis.ticks.y=element_blank(),
    legend.title = element_text(size = 9, face = "bold"),
    legend.text = element_text(size = 7.5),
    legend.key.size = unit(0.4, "cm")
  )

```

## Interpretación del dashboard

En el dashboard (link) se presenta una gráfica interactiva 

```{r plot_dash_1, include = TRUE, echo = TRUE}

meta_centroids = st_centroid(meta_RAO)

# En el dashboard, 
ggplot()+
  geom_sf(data = meta_RAO, 
          aes(fill = RAO),
          color = NA)+
  geom_label_repel( data = meta_centroids %>% 
                     filter(UCS_F == "RVGay") %>%
                     distinct(., geometry, .keep_all = TRUE),   
                   aes(label = UCS_F, geometry = geometry),
                   alpha = 0.7,
                   col = "grey30",
                   size = 3,
                   force_pull  = 0.2,
                   max.overlaps = Inf,
                   direction = "both",
                   box.padding = 0.5,
                   stat = "sf_coordinates",
                   family = "roboto",
                   segment.size = 0.3,
                   segment.square = FALSE,
                   segment.curvature = -0.3,
                   segment.angle = 30, 
                   segment.ncp = 10,
                   show.legend = FALSE) +
  theme(legend.position = "top")+
  scale_fill_gradientn(colours = pal)+
  guides(colour = "none",
         fill = guide_colourbar(title.position = "top",
                                title.hjust = 0.5,
                                barwidth = unit(15,"lines"),
                                barheight = unit(0.5,"lines")))+
  scale_x_continuous(breaks=c(-74, -73, -72))+
  scale_y_continuous(breaks=c(2,3))





```


