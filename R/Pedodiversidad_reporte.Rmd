---
title: "PECIG Colombia"
subtitle: "Diversidad de suelos"
author: "Carlos Guio"
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) { 
      out_dir <- 'Reportes';
      rmarkdown::render(input = inputFile,
                        encoding = encoding, 
                        output_file = file.path(
                                        here::here(), 
                                        out_dir, 
                                        '01_PECIG_Pedodiversidad.html'))
                                        })
output:
  html_document:
    theme: journal
    highlight: tango
    keep_md: true
---


```{r setup, message=FALSE, warning=FALSE}

library(tidyverse)
library(rgdal) #leer polígono
library(sf) #manipular objetos espaciales tipo sf
library(raster) #manipular objetos raster
library(ggplot2)
library(showtext) #fuentes de goolge
library(colorspace) #lighten or darken colors
library(ggrepel) #etiquetas 
library(ggsn) #escala gráfica

knitr::opts_chunk$set(include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align="center", fig.showtext = TRUE, fig.retina = 1, dpi = 300, out.width = "70%")

showtext_auto()

```

## Rationale

Los datos de suelo en la toma de decisiones ambientales. Los tipos de datos de suelo posibles. Su representación.

## Los datos

Los polígonos donde se realizaría la aspersión -llamados núcleos en el documento del PECIG(2020) - se obtuvieron de la página web de la Agencia Nacional de Licencias Ambientales (ANLA). La información geográfica de suelos por departamento se obtuvo de los datos abiertos del IGAC en 2019 y 2020. La información de perfiles de suelo se obtuvo de los estudios de suelo del IGAC de los departamentos respectivos, publicados en 2014. Debido a la disponibilidad de datos, se presentan únicamente los casos del núcleo san josé (departamentos Meta, Vichada y Guaviare) y el núcleo caquetá (departamento Caquetá) .


```{r load_raw}

#Como mejorar velocidad? modificar los .shp originales para que tengan tablas de atributos solo con los campos necesarios.

#Cargar datos espaciales

temp <- tempfile() #Crear objetos temporales
tempd <- tempdir()

urls <- list()

urls$nucleos <- "https://github.com/cmguiob/TERRAE_PECIG_dashaboard/blob/main/Datos_SIG/Area_Influencia_Directa_19022020.zip?raw=true"

urls$meta <- "https://github.com/cmguiob/TERRAE_PECIG_dashaboard/blob/main/Datos_SIG/IGAC_2020_META_SUELOS_1_100.zip?raw=true"

urls$guaviare <- "https://github.com/cmguiob/TERRAE_PECIG_dashaboard/blob/main/Datos_SIG/IGAC_2020_GUAVIARE_SUELOS_1_100.zip?raw=true"

urls$vichada <- "https://github.com/cmguiob/TERRAE_PECIG_dashaboard/blob/main/Datos_SIG/IGAC_2019_VICHADA_SUELOS_1_100.zip?raw=true"

urls$caqueta <- "https://github.com/cmguiob/TERRAE_PECIG_dashaboard/blob/main/Datos_SIG/IGAC_2020_CAQUETA_SUELOS_1_100.zip?raw=true"

for (i in 1:length(urls)){
  download.file(urls[[i]],temp, mode="wb")
  unzip(temp, exdir=tempd) #Descomprimir
}

files_names <- list.files(tempd, pattern = "*.geojson") #Leer nombres de archivos
files_paths <- paste(file.path(tempd), files_names[], sep = "\\") #Crear rutas

#REEMPLAZAR SUELOS DEPTO POR DEPTO SOLAMENTE
nucleos <- files_paths %>% .[str_detect(.,"Area_Influencia_Directa")] %>% st_read()
#meta <- files_paths %>% .[str_detect(.,"META")] %>% st_read()
#guaviare <- files_paths %>% .[str_detect(.,"GUAVIARE")] %>% st_read()
#vichada <- files_paths %>% .[str_detect(.,"VICHADA")] %>% st_read()
#caqueta <- files_paths %>% .[str_detect(.,"CAQUETA")] %>% st_read()

ggplot() + 
  geom_sf(data = meta, color = "#d96011", fill = "#d96011")+
  geom_sf(data = vichada, color = "#e7ab17", fill = "#e7ab17")+
  geom_sf(data = guaviare, color = "#7570b4", fill="#7570b4")+
  geom_sf(data = caqueta, color = "#66a61f", fill = "#66a61f")+
  geom_sf(data = nucleos, fill = "grey50", color = "grey10", alpha = 0.5)+
  theme_minimal()
  

head(meta)


```

## Preprocesamiento en QGIS

A los polígonos obtenidos del IGAC se les corrigieron geometrías y se generaron índices espaciales en QGIS. Posteriormente se realizaron las intersecciones de los polígonos de suelos por departamento con los polígonos de núcleos de aspersión, para limitar el objeto de estudio, utilizando la función clip. A los polígonos resultantes se les agregó una campo que especifíca el núcleo.


## Indice de pedodiversidad

En los polígonos de suelos resultantes se identifican los códigos de las UCS, los suelos que las conforman y los identificadores de los perfiles de suelos. 

Para estimar la pedodiversidad se utilizó el algoritmo propuesto por Rositter para estimar la similitud entre suelos. La automatización la estoy documentando en otro repositorio (link). Según el algorítmo...

Los polígonos y los índices de pedodiversidad

```{r load_processed}

#Debido a velocidad, se hizo la intesección en QGIS. Cargar los núcleos

urls$deptos_nucleos <- "https://github.com/cmguiob/TERRAE_PECIG_dashaboard/blob/main/Datos_SIG/Suelos_Departamentos_Nucleos_1_2.zip?raw=true"

for (i in 1:length(urls)){
  download.file(urls[[i]],temp, mode="wb")
  unzip(temp, exdir=tempd) #Descomprimir
}

files_names <- list.files(tempd, pattern = "*.geojson") #Leer nombres de archivos
files_paths <- paste(file.path(tempd), files_names[], sep = "\\") #Crear rutas

nucleos <- files_paths %>% .[str_detect(.,"Area_Influencia_Directa")] %>% st_read()
meta_nucleo <- files_paths %>% .[str_detect(.,"meta_")] %>% st_read()
guaviare_nucleo <- files_paths %>% .[str_detect(.,"guaviare_")] %>% st_read()
vichada_nucleo <- files_paths %>% .[str_detect(.,"vichada_")] %>% st_read()
caqueta_nucleo <- files_paths %>% .[str_detect(.,"caqueta_")] %>% st_read()

ggplot() + 
  geom_sf(data = meta_nucleo, color = "#d96011", fill = "#d96011")+
  geom_sf(data = vichada_nucleo, color = "#e7ab17", fill = "#e7ab17")+
  geom_sf(data = guaviare_nucleo, color = "#7570b4", fill="#7570b4")+
  geom_sf(data = caqueta_nucleo, color = "#66a61f", fill = "#66a61f")+
  geom_sf(data = nucleos, fill = "grey50", color = "grey10", alpha = 0.7)+
  theme_minimal()
  

# Cargar resultados del algoritmo. Hacer join por UCS_F

RAO_nucleos <- read_csv("https://raw.githubusercontent.com/cmguiob/TERRAE_PECIG_dashaboard/main/Resultados/Pedodiversidad_RAO_nucleos_1_2.csv") %>%
  mutate(NUCLEO = case_when(
    NUCLEO_ID == 1 ~ "San Jose",
    NUCLEO_ID == 2 ~ "Caqueta"))

#Join

meta_RAO <- left_join(meta_nucleo, RAO_nucleos %>% filter(DEPARTAMENTO == "Meta"), by = c("UCS_F", "DEPARTAMENTO"))

guaviare_RAO <- left_join(guaviare_nucleo, RAO_nucleos %>% filter(DEPARTAMENTO == "Guaviare"), by = c("UCS_F", "DEPARTAMENTO"))

vichada_RAO <- left_join(vichada_nucleo, RAO_nucleos %>% filter(DEPARTAMENTO == "Vichada"), by = c("UCS_F", "DEPARTAMENTO"))

caqueta_RAO <- left_join(caqeuta_nucleo, RAO_nucleos %>% filter(DEPARTAMENTO == "Caqueta"), by = c("UCS_F", "DEPARTAMENTO"))


ggplot() +
  geom_sf(data = meta_RAO, aes(fill = RAO), color = NA )+
  geom_sf(data = guaviare_RAO, aes(fill = RAO),color = NA)+
  geom_sf(data = vichada_RAO, aes(fill = RAO),color = NA)+
  scale_fill_viridis() + 
  theme_minimal()

```

```{r plot_incertidumbre}

library(gghalves)

#graficar snapshot del dashboard para meta

ggplot(RAO_nucleos, aes(y = RAO, x = NUM_SUELOS)) +
  geom_half_violin(width=1.4, alpha=0.4, color = NA, fill = "#CDC0B0", trim = FALSE, side = "l")+
  geom_boxplot(width=0.2, color="black",show.legend = FALSE,  alpha=0.4, lwd=0.2, outlier.size = 0.001)+
  geom_half_point_panel(aes(color = UCS_TIPO), alpha = 0.6, side = "r", range_scale = 0.1, size = 0.4, transformation = position_jitter())+
  scale_colour_manual(name = "Tipo de UCS", 
                      values = c("Consociacion" = "#5B9F90", "Asociacion" = "#B6B800","Complejo" = "#F0C73B",  "Disociacion" = "#E96149"),
                      breaks=c('Disociacion','Complejo','Asociacion','Consociacion'))+
  theme_bw(base_size = 9, base_family = "Comfortaa")+
  guides(color = guide_legend(override.aes = list(size = 2)))+
  labs(y = "Incertidumbre (entropía cuadratica)", x = "Numero de suelos reportados por UCS")+
  facet_grid(~ DEPARTAMENTO, scales = "free")+
  theme(
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank(),
    strip.background = element_blank(),
    strip.text = element_text(face="bold", color = "#CDC5BF", size = 9),
    axis.text = element_text(size=6.5),
    axis.title= element_text(size = 7.5),
    axis.title.x = element_text(margin = margin(t = 8)),
    axis.title.y = element_text(margin = margin(r = 8)),
    axis.ticks.length.x = unit(.5, "mm"),
    axis.ticks.length.y = unit(.1, "mm"),
    axis.ticks.y=element_blank(),
    legend.title = element_text(size = 9, face = "bold"),
    legend.text = element_text(size = 7.5),
    legend.key.size = unit(0.4, "cm")
  )

```


## Interpretación del dashboard

En el dashboard (link) se presenta una gráfica interactiva 

```{r}

ggplot()+
  geom_sf(data = nucleos %>% filter(OBSERV), fill = "grey50", color = NA, alpha = 0.5) +
  geom_sf(data = meta_RAO, aes(fill = RAO), color = NA) +
  scale_fill_viridis()+
  theme_minimal()

```

